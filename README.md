# Quickstart example

Make sure CouchDB is installed, and currently running. This example assumes that the server is
running in localhost, using the default 5984 port. Yason's alist encoder/decoder is used below to
make replies readable.

    CL-USER> (require 'chillax)
    CL-USER> (in-package :chillax)
    CHILLAX> (defparameter *server* (make-instance 'yason-server :object-as-alist-p t
                                                   :parse-object-key-fun
                                                   (lambda (string) (intern string *package*))))
    *SERVER*
    CHILLAX> (defparameter *db* (ensure-db *server* "test"))
    *DB*
    CHILLAX> (all-documents *db*)
    ((|rows|) (|offset| . 0) (|total_rows| . 0))
    CHILLAX> (put-document *db* "my_test_doc" '((name . "Kat") (favorite-language . "common-lisp")))
    ((|rev| . "1-3c964cc898c03c48903a91d90b24a269")
     (|id| . "my_test_doc") (|ok| . T))
    CHILLAX> (get-document *db* "my_test_doc")
    ((FAVORITE-LANGUAGE . "common-lisp")
     (NAME . "Kat")
     (|_rev| . "1-3c964cc898c03c48903a91d90b24a269")
     (|_id| . "my_test_doc"))
    CHILLAX> (delete-document *db* (cdr (assoc '|_id| *)) (cdr (assoc '|_rev| *)))
    ((|rev| . "2-2221fc2b97c1fac1a82ba07d2835ac80")
     (|id| . "my_test_doc")
     (|ok| . T))

# Introduction

Chillax is a [CouchDB](http://couchdb.apache.org) abstraction layer for Common Lisp licensed under
the MIT license. The original author of chillax is [Kat MarchÃ¡n](http://github.com/zkat);
[Ian McEwen](http://github.com/ianmcorvidae) subsequently worked on CLOS bindings, since
the original version was written for [Sheeple](http://github.com/zkat/sheeple).

Chillax also includes a CouchDB view server, which can be made with
make-chillax-server.lisp. Currently supported by make-chillax-server.lisp are sbcl and ccl.

Chillax includes several systems:

* chillax.asd - This is a 'DWIM' system. It uses Yason to parse/encode JSON data. If you don't know
  what you want, this is probably what you want.
* chillax.core.asd - Core API and protocols for servers, databases, documents, and
  design-docs.
* chillax.yason.asd - Implementation of the server protocol using Yason's JSON parser.
* chillax.utils.asd - Some handy utilities.
* chillax.view-server.asd - The Chillax view server. This only depends on chillax.utils.

# Core API

The basic Chillax API is very straightforward: It is a thin, lispy layer on top of CouchDB's RESTful
API. Its main purpose is to provide Lisp functions to all of CouchDB's API calls, while translating
certain things into Lisp data and concepts. For example, Chillax takes care of checking CouchDB's
HTTP response codes for sanity. When error codes are returned, Chillax will signal Lisp
corresponding Lisp conditions.

Additionally, Chillax is able to use any representation for CouchDB documents, provided the core
Chillax protocols are implemented for that representation, i.e, you can use hash tables, alists, or
instances of classes as your 'documents', and Chillax will automatically serialize/deserialize JSON
communications with CouchDB according to the protocol's implementation.

Note that, since Chillax really is just a thin layer, it abstracts very little beyond the
above. Most Chillax functions will simply return the de-JSON-ified CouchDB responses, and leave you
to digging through the response objects for the data you need.

## Server API

*[function]* `server-uri server`

  Returns a string representation of the URL SERVER represents.


*[function]* `all-dbs server`

  Requests a list of all existing databases from SERVER.


*[function]* `config-info server`

  Requests the current configuration from SERVER.


*[function]* `replicate server target &key create-target-p continuousp`

  Replicates the database in SOURCE to TARGET. SOURCE and TARGET can both be either database names
  in the local server, or full URLs to local or remote databases. If CREATE-TARGET-P is true, the
  target database will automatically be created if it does not exist. If CONTINUOUSP is true,
  CouchDB will continue propagating any changes in SOURCE to TARGET.


*[function]* `stats server`

  Requests general statistics from SERVER.


*[function]* `active-tasks server`

  Lists all the currently active tasks on SERVER.


*[function]* `get-uuids server &key (number 10)`

  Returns a list of NUMBER unique IDs requested from SERVER. The UUIDs generated by the server are
  reasonably unique, but are not checked against existing UUIDs, so conflicts may still happen.


## Database API

*[function]* `db-info db`

  Fetches info about a given database from the CouchDB server.


*[function]* `db-connect server name`

  Confirms that a particular CouchDB database exists. If so, returns a new database object that can
  be used to perform operations on it. Will signal a DB-NOT-FOUND error if the database does not
  already exist.


*[function]* `db-create server name`

  Creates a new CouchDB database. Returns a database object that can be used to operate on it. Will
  signal a DB-ALREADY-EXISTS error if there is already a database with the same NAME in SERVER.


*[function]* `ensure-db server name`

  Either connects to an existing database, or creates a new one. Returns two values: If a new
  database was created, (DB-OBJECT T) is returned. Otherwise, (DB-OBJECT NIL).


*[function]* `db-delete db`

  Deletes a CouchDB database.


*[function]* `db-compact db`

  Triggers a database compaction.


*[function]* `db-changes db`

  Returns the changes feed for DB


*[function]* `db-uri db`

  Returns a string representing the full URI for DB.


## Document API

All document arguments to these functions must be Lisp objects that the database's server is able to
encode to JSON. These functions will likewise return Lisp objects that represent the parsed JSON
responses from CouchDB. Exact representations will depend on the server being used.

*[function]* `get-document db id &key key startkey endkey limit include-docs`

  Finds a CouchDB document in DB, named by ID.


*[function]* `all-documents db &rest all-keys`

  Requests the \_all\_docs document. ALL-KEYS correspond to GET-DOCUMENT's keyword arguments.


*[function]* `batch-get-documents db &rest doc-ids`

  Uses \_all\_docs to quickly fetch the given DOC-IDs in a single request. Note that this function
  will NOT signal a DOCUMENT-NOT-FOUND error when one or more DOC-IDs are not found. Instead, the
  results will be returned, and it's the user's responsibility to deal with any missing docs.


*[function]* `put-document db id doc &key batch-ok-p`

  Puts a document into DB, using ID. DOC must be Lisp data that DB's server is able to convert to
  JSON.


*[function]* `post-document db doc`

  POSTs a document into DB. CouchDB will automatically assign a UUID if the document does not
  already exist. Note that using this function is discouraged in the CouchDB documentation, since it
  may result in duplicate documents because of proxies and other network intermediaries.


*[function]* `delete-document db id revision`

  Deletes an existing document.


*[function]* `copy-document from-id to-id &key revision`

  Copies a document's content in-database.


# Core Protocol

You can use the core protocol to customize behavior of Chillax. Writing your own implementation for
this protocol is relatively simple and painless, and it allows you to do things such as use your own
custom JSON encoder/decoder, if Yason doesn't fit your needs. Classes that implement the protocols,
and their behavior, is documented here, as well.

## Server Protocol

*[generic function]* `server-host server`
*[generic function]* `server-port server`
*[generic function]* `server-username server`
*[generic function]* `server-password server`
*[generic function]* `server-secure-p server`

*[generic function]* `data->json server data &key`

  Converts DATA to JSON suitable for sending to CouchDB.


*[generic function]* `json->data server json &key`

  Converts JSON to the desired data structure.

*[generic function]* `make-db-object server name`

  Creates an object which represents a database connection in SERVER. The object must conform to the
  database protocol.

### Included protocol implementations

*[standard class]* `standard-server`

  Basic implementation of the server protocol. JSON data is handled literally as strings, with no
  conversion.

*[standard class]* `yason-server`

  YASON-SERVERs use Yason's JSON parser/encoder to automatically translate content going to/coming
  from the associated CouchDB server.

  It supports the following initargs:

  * :array-as-vector-p - If TRUE, parses JSON arrays as Lisp vectors. (default: nil)
  * :boolean-as-symbol-p - If TRUE, parses JSON booleans as symbols instead of CL booleans. (default: nil)
  * :object-as-alist-p - If TRUE, parses JSON objects as alists, instead of hash tables. (default: nil)
  * :parse-object-key-fun - Function to process object keys with. (default: #'CL:IDENTITY)

## Database Protocol

*[generic function]* `database-server database`

  Returns the server object with which DATABASE is associated.


*[generic function]* `database-name database`

  Returns the URL-encoded name of the database, a string. Note that CouchDB accepts certain
  characters in database names -only- if they are URL-encoded (such as #\/). It is up to individual
  implementations of DATABASE-NAME to implement this encoding."


### Included protocol implementation

*[standard class]* `standard-database`

  Minimal, class-based implementation of the database protocol.


# View Server

The Chillax View Server allows you to write views in full-fledged Common Lisp. In order to use the
server, you must create a binary using code loaded by chillax.view-server.asd, and make
chillax-server::run-server the toplevel function.

Once you put the binary in a place visible to the CouchDB process, add the following to
/etc/couchdb/local.ini (or wherever your local.ini is located):

    [query_servers]
    common-lisp = /path/to/chillax-view-server

Add the common-lisp entry if there's already a query_servers entry.

Once you've done this, you can start making queries directly in Lisp!

    CHILLAX> (invoke-temporary-view *db* :language "common-lisp"
                                         :map (prin1-to-string '(lambda (doc) (emit doc 1))))

You can load anything you want into the view server image before dumping it, customize which package
it executes views in, etc. The source code is fairly short and easy to digest. It's designed to be
customizable for whatever your needs are.

# Yason Problem

Note that, at least on some systems, versions of [Yason](http://github.com/hanshuebner/Yason) prior
to commit
[00b9a5c06b7c4113a48518a1f136637efb4458b9](http://github.com/hanshuebner/Yason/commit/00b9a5c06b7c4113a48518a1f136637efb4458b9)
will not work (in this commit, #\Return was added to the list of whitespace characters
recognized). Using these versions instead of 0.1 is recommended anyway for performance reasons.
